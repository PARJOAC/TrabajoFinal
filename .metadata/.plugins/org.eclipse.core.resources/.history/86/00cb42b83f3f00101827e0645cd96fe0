package controlador;

import util.Contrasena;
import util.MiExcepcion;
import vista.VistaSegunUsuario;
import vista.login.VistaLogin;

import javax.swing.*;

import bd.DAOUsuarios;
import constructores.Usuario;

import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;

public class ControladorLogin implements ActionListener {

	private final VistaLogin loginView;
	private final DAOUsuarios dao;

	public ControladorLogin(VistaLogin loginView) {
		this.loginView = loginView;
		this.dao = new DAOUsuarios();
		this.loginView.getBotonLogin().addActionListener(this);
	}

	@Override
	public void actionPerformed(ActionEvent e) {
		try {
			login();
		} catch (Exception ex) {
			JOptionPane.showMessageDialog(loginView, "Error: " + ex.getMessage(), "Error", JOptionPane.ERROR_MESSAGE);
		}
	}

	private void login() throws MiExcepcion {
		String usuario = loginView.getCampoUsuario().getText().trim();
		String pass = new String(loginView.getCampoContrasena().getPassword()).trim();

		if (usuario.isEmpty() || pass.isEmpty()) {
			JOptionPane.showMessageDialog(loginView, "Rellena todos los campos", "Aviso", JOptionPane.WARNING_MESSAGE);
			return;
		}

		Usuario u = dao.buscarUsuario(usuario);
		if (u == null) {
			JOptionPane.showMessageDialog(loginView, "Usuario no encontrado", "Error", JOptionPane.ERROR_MESSAGE);
			return;
		}

		if (!u.getPassword().equals(Contrasena.cifrar(pass))) {
			JOptionPane.showMessageDialog(loginView, "Contraseña incorrecta", "Error", JOptionPane.ERROR_MESSAGE);
			return;
		}

		// Éxito: abrir la vista según el usuario
		new VistaSegunUsuario(u);
		loginView.dispose();
	}
}
